name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.11", "3.12", "3.13"]
        include:
          - os: windows-latest
            python-version: "3.11"

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Verify Java installation
      run: |
        java -version
        echo "JAVA_HOME=$JAVA_HOME"

    - name: Set up Hadoop winutils (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        mkdir "%RUNNER_TEMP%\hadoop\bin"
        curl -L -o "%RUNNER_TEMP%\hadoop\bin\winutils.exe" "https://github.com/cdarlint/winutils/raw/master/hadoop-3.3.5/bin/winutils.exe"
        curl -L -o "%RUNNER_TEMP%\hadoop\bin\hadoop.dll" "https://github.com/cdarlint/winutils/raw/master/hadoop-3.3.5/bin/hadoop.dll"
        if not exist "%RUNNER_TEMP%\hadoop\bin\winutils.exe" exit /b 1
        echo HADOOP_HOME=%RUNNER_TEMP%\hadoop>> "%GITHUB_ENV%"
        echo %RUNNER_TEMP%\hadoop\bin>> "%GITHUB_PATH%"

    - name: Verify Hadoop home (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        echo HADOOP_HOME=%HADOOP_HOME%
        dir "%HADOOP_HOME%\bin"

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -e ".[dev]"

    - name: Run tests
      run: |
        pytest tests/ -v --tb=short

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install "black==26.1.0" "ruff==0.15.1"

    - name: Check code formatting with black
      run: |
        black --check databricks_shim/ tests/ main.py

    - name: Lint with ruff
      run: |
        ruff check databricks_shim/ tests/ main.py

  coverage:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -e ".[dev]"
        pip install pytest-cov

    - name: Run tests with coverage
      run: |
        pytest tests/ --cov=databricks_shim --cov-report=xml --cov-report=html

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
